name: Create Release on Merge to Main

on:
  push:
    branches:
      - main

jobs:
  create-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Get Current Date
        id: date
        run: echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_ENV

      - name: Find the Excel File
        id: find_file
        run: |
          FILE=$(git ls-files | grep -i 'Form 3018, Rockwell.xlsm' | head -n 1)
          if [ -z "$FILE" ]; then
            echo "❌ Error: Form 3018, Rockwell.xlsm not found."
            exit 1
          fi
          echo "FOUND_FILE=$FILE" >> $GITHUB_ENV

      - name: Rename File with Date Suffix
        run: |
          NEW_NAME="${GITHUB_ENV// /_}"
          mv "$FOUND_FILE" "Form_3018_Rockwell_${{ env.date }}.xlsm"
          echo "RENAMED_FILE=Form_3018_Rockwell_${{ env.date }}.xlsm" >> $GITHUB_ENV

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.date }}
          release_name: "Release ${{ env.date }}"
          body: "Automated release of Form 3018, Rockwell.xlsm on ${{ env.date }}."
          files: "Form_3018_Rockwell_${{ env.date }}.xlsm"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
